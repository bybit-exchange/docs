"use strict";(self.webpackChunkdocusaurus_docs=self.webpackChunkdocusaurus_docs||[]).push([[5264],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>u});var a=n(67294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),o=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},d=function(e){var t=o(e.components);return a.createElement(p.Provider,{value:t},e.children)},m={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},k=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,d=s(e,["components","mdxType","originalType","parentName"]),k=o(n),u=r,c=k["".concat(p,".").concat(u)]||k[u]||m[u]||i;return n?a.createElement(c,l(l({ref:t},d),{},{components:n})):a.createElement(c,l({ref:t},d))}));function u(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,l=new Array(i);l[0]=k;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,l[1]=s;for(var o=2;o<i;o++)l[o]=n[o];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}k.displayName="MDXCreateElement"},10539:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>i,metadata:()=>s,toc:()=>o});var a=n(87462),r=(n(67294),n(3905));const i={title:"SBE BBO Integration",sidebar_label:"SBE BBO Integration",sidebar_position:1},l=void 0,s={unversionedId:"v5/sbe/bbo/sbe-bbo",id:"v5/sbe/bbo/sbe-bbo",title:"SBE BBO Integration",description:"Overview",source:"@site/docs/v5/sbe/bbo/sbe-bbo.mdx",sourceDirName:"v5/sbe/bbo",slug:"/v5/sbe/bbo/sbe-bbo",permalink:"/docs/v5/sbe/bbo/sbe-bbo",draft:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"SBE BBO Integration",sidebar_label:"SBE BBO Integration",sidebar_position:1},sidebar:"v5SideBar",previous:{title:"SBE Basic Information",permalink:"/docs/v5/sbe/sbe-basic-info"},next:{title:"SBE Level 50 Integration",permalink:"/docs/v5/sbe/level-50/sbe-level-50"}},p={},o=[{value:"Overview",id:"overview",level:2},{value:"Connection",id:"connection",level:2},{value:"Data Frame Type",id:"data-frame-type",level:3},{value:"Control Messages",id:"control-messages",level:3},{value:"Subscription Flow",id:"subscription-flow",level:2},{value:"Send subscription request",id:"send-subscription-request",level:3},{value:"Subscription confirmation",id:"subscription-confirmation",level:3},{value:"Receive data",id:"receive-data",level:3},{value:"Decode example",id:"decode-example",level:3},{value:"SBE Message Structure",id:"sbe-message-structure",level:2},{value:"SBE XML Schema",id:"sbe-xml-schema",level:3},{value:"Message Structure Details",id:"message-structure-details",level:3},{value:"Message Header (8 bytes)",id:"message-header-8-bytes",level:4},{value:"Message Body (<code>BestOBRpiEvent</code>)",id:"message-body-bestobrpievent",level:4},{value:"Variable-Length String (<code>varString8</code>)",id:"variable-length-string-varstring8",level:4},{value:"Optimisation",id:"optimisation",level:2},{value:"Optimisation 1",id:"optimisation-1",level:3},{value:"Optimisation 2",id:"optimisation-2",level:3},{value:"Optimisation 3",id:"optimisation-3",level:3},{value:"Case 1: <code>askNormalSize != 0 &amp;&amp; askRpiSize != 0</code>",id:"case-1-asknormalsize--0--askrpisize--0",level:4},{value:"Case 2: <code>askNormalSize != 0 &amp;&amp; askRpiSize == 0</code>",id:"case-2-asknormalsize--0--askrpisize--0",level:4},{value:"Case 3: <code>askNormalSize == 0 &amp;&amp; askRpiSize != 0</code>",id:"case-3-asknormalsize--0--askrpisize--0",level:4},{value:"Case 4",id:"case-4",level:4},{value:"Integration Example",id:"integration-example",level:2}],d={toc:o};function m(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"overview"},"Overview"),(0,r.kt)("p",null,"Bybit provides real-time Level 1 Orderbook data in ",(0,r.kt)("strong",{parentName:"p"},"SBE (Simple Binary Encoding)")," format, following the FIX Protocol SBE 1.0 specification."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The current version only supports ",(0,r.kt)("strong",{parentName:"li"},"SBE binary")," format."),(0,r.kt)("li",{parentName:"ul"},"For linear / inverse / spot Level 1 data: if 3 seconds have elapsed without a change in the orderbook, a snapshot message will be pushed again, and the field ",(0,r.kt)("inlineCode",{parentName:"li"},"u")," will be the same as that in the previous message."),(0,r.kt)("li",{parentName:"ul"},"Under extreme market conditions, there are merge and packet-drop strategies on both the generation side and the push side, so ",(0,r.kt)("strong",{parentName:"li"},(0,r.kt)("inlineCode",{parentName:"strong"},"u")," continuity is not guaranteed"),".")),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"connection"},"Connection"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"Please use your ",(0,r.kt)("strong",{parentName:"p"},"dedicated MMWS host")," for mainnet SBE connections.")),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("p",{parentName:"li"},"From January 15, 2026, sbe connection will only be avaiable via ",(0,r.kt)("strong",{parentName:"p"},"v5/public-sbe")))),(0,r.kt)("h3",{id:"data-frame-type"},"Data Frame Type"),(0,r.kt)("p",null,"SBE messages are transmitted as ",(0,r.kt)("strong",{parentName:"p"},"binary WebSocket frames")," (opcode = 2)."),(0,r.kt)("h3",{id:"control-messages"},"Control Messages"),(0,r.kt)("p",null,"Control messages (subscription, unsubscription, ping/pong, etc.) follow the ",(0,r.kt)("strong",{parentName:"p"},"Bybit V5 WebSocket JSON standard"),"."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"subscription-flow"},"Subscription Flow"),(0,r.kt)("h3",{id:"send-subscription-request"},"Send subscription request"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "op": "subscribe",\n  "args": ["ob.rpi.1.sbe.BTCUSDT"]\n}\n')),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Topic format: ",(0,r.kt)("inlineCode",{parentName:"li"},"ob.rpi.1.sbe.<symbol>")),(0,r.kt)("li",{parentName:"ul"},"Example symbols: ",(0,r.kt)("inlineCode",{parentName:"li"},"BTCUSDT"),", ",(0,r.kt)("inlineCode",{parentName:"li"},"ETHUSDT"),", etc.")),(0,r.kt)("h3",{id:"subscription-confirmation"},"Subscription confirmation"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "success": true,\n  "ret_msg": "",\n  "conn_id": "d30fdpbboasp1pjbe7r0",\n  "req_id": "xxx",\n  "op": "subscribe"\n}\n')),(0,r.kt)("h3",{id:"receive-data"},"Receive data"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'b"R\\x00 N\\x01\\x00\\x00\\x00\\xdb\\x84\\xd0k\\x00\\x00\\x00\\x00f\\xb7\\x003\\x99\\x01\\x00\\x00\\x02\\x06\\xa1\\xcb\\xa1\\x00\\x00\\x00\\x00\\x00\\xe7\\xda\\x0b\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x04\\xc8\\xa1\\x00\\x00\\x00\\x00\\x00 N\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x008\\x01\\x00\\x00\\x00\\x00\\x00\\x00v\\xba\\x003\\x99\\x01\\x00\\x00\\x07BTCUSDT"\n')),(0,r.kt)("h3",{id:"decode-example"},"Decode example"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "header": {\n    "block_length": 82,\n    "template_id": 20000,\n    "schema_id": 1,\n    "version": 0\n  },\n  "seq": 1808827611,\n  "cts": 1757497309030,\n  "price_exponent": 2,\n  "size_exponent": 6,\n  "ask_price": 1060342500,\n  "ask_normal_size": 776935000000,\n  "ask_rpi_size": 0,\n  "bid_price": 1060250000,\n  "bid_normal_size": 20000000000,\n  "bid_rpi_size": 0,\n  "u": 312,\n  "ts": 1757497309814,\n  "symbol": "BTCUSDT",\n  "parsed_length": 98\n}\n')),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"sbe-message-structure"},"SBE Message Structure"),(0,r.kt)("h3",{id:"sbe-xml-schema"},"SBE XML Schema"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The ",(0,r.kt)("inlineCode",{parentName:"li"},"templateId = 20000")," identifies the message type."),(0,r.kt)("li",{parentName:"ul"},"Validate that ",(0,r.kt)("inlineCode",{parentName:"li"},"templateId = 20000")," to confirm it is a Level 1 Orderbook event.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-xml"},'<?xml version="1.0" encoding="UTF-8"?>\n<sbe:messageSchema xmlns:sbe="http://fixprotocol.io/2016/sbe"\n                   xmlns:mbx="https://bybit-exchange.github.io/docs/v5/intro"\n                   package="quote.sbe"\n                   id="1"\n                   version="0"\n                   semanticVersion="1.0.0"\n                   description="Bybit market data streams SBE message schema"\n                   byteOrder="littleEndian"\n                   headerType="messageHeader">\n\n  <types>\n    <composite name="messageHeader" description="Template ID and length of message root">\n      <type name="blockLength" primitiveType="uint16"/>\n      <type name="templateId" primitiveType="uint16"/>\n      <type name="schemaId" primitiveType="uint16"/>\n      <type name="version" primitiveType="uint16"/>\n    </composite>\n\n    <composite name="varString8" description="Variable length UTF-8 string.">\n      <type name="length" primitiveType="uint8"/>\n      <type name="varData"\n            length="0"\n            primitiveType="uint8"\n            semanticType="String"\n            characterEncoding="UTF-8"/>\n    </composite>\n  </types>\n\n  \x3c!-- Stream event for "ob.rpi.1.sbe.<symbol>" channel --\x3e\n  <sbe:message name="BestOBRpiEvent" id="20000">\n    <field id="1"  name="ts"             type="int64" description="The timestamp in microseconds that the system generates the data"/>\n    <field id="2"  name="seq"            type="int64" description="Cross sequence ID"/>\n    <field id="3"  name="cts"            type="int64" description="The timestamp in microseconds from the matching engine when this orderbook data is produced."/>\n    <field id="4"  name="u"              type="int64" description="Update Id"/>\n    <field id="5"  name="askNormalPrice" type="int64" mbx:exponent="priceExponent" description="Mantissa for the best ask normal price"/>\n    <field id="6"  name="askNormalSize"  type="int64" mbx:exponent="sizeExponent" description="Mantissa for the best ask normal size"/>\n    <field id="7"  name="askRpiPrice"    type="int64" mbx:exponent="priceExponent" description="Mantissa for the best ask rpi price"/>\n    <field id="8"  name="askRpiSize"     type="int64" mbx:exponent="sizeExponent" description="Mantissa for the best ask rpi size"/>\n    <field id="9"  name="bidNormalPrice" type="int64" mbx:exponent="priceExponent" description="Mantissa for the best bid normal price"/>\n    <field id="10" name="bidNormalSize"  type="int64" mbx:exponent="sizeExponent" description="Mantissa for the best bid normal size"/>\n    <field id="11" name="bidRpiPrice"    type="int64" mbx:exponent="priceExponent" description="Mantissa for the best bid rpi price"/>\n    <field id="12" name="bidRpiSize"     type="int64" mbx:exponent="sizeExponent" description="Mantissa for the best bid rpi size"/>\n    <field id="13" name="priceExponent"  type="int8"  description="Price exponent for decimal point positioning"/>\n    <field id="14" name="sizeExponent"   type="int8"  description="Size exponent for decimal point positioning"/>\n    <data  id="55" name="symbol"         type="varString8"/>\n  </sbe:message>\n</sbe:messageSchema>\n')),(0,r.kt)("h3",{id:"message-structure-details"},"Message Structure Details"),(0,r.kt)("h4",{id:"message-header-8-bytes"},"Message Header (8 bytes)"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Field"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Size (bytes)"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"blockLength"),(0,r.kt)("td",{parentName:"tr",align:null},"uint16"),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"Message body length")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"templateId"),(0,r.kt)("td",{parentName:"tr",align:null},"uint16"),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"Fixed = 20000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"schemaId"),(0,r.kt)("td",{parentName:"tr",align:null},"uint16"),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"Fixed = 1")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"version"),(0,r.kt)("td",{parentName:"tr",align:null},"uint16"),(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"Fixed = 0")))),(0,r.kt)("h4",{id:"message-body-bestobrpievent"},"Message Body (",(0,r.kt)("inlineCode",{parentName:"h4"},"BestOBRpiEvent"),")"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"ID"),(0,r.kt)("th",{parentName:"tr",align:null},"Field"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"1"),(0,r.kt)("td",{parentName:"tr",align:null},"ts"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Snapshot timestamp (\xb5s)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"2"),(0,r.kt)("td",{parentName:"tr",align:null},"seq"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Unique message sequence number")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"3"),(0,r.kt)("td",{parentName:"tr",align:null},"cts"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Trade timestamp (\xb5s)")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"4"),(0,r.kt)("td",{parentName:"tr",align:null},"u"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Update ID")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"5"),(0,r.kt)("td",{parentName:"tr",align:null},"askNormalPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Best ask price mantissa")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"6"),(0,r.kt)("td",{parentName:"tr",align:null},"askNormalSize"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Best ask size (normal) mantissa")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"7"),(0,r.kt)("td",{parentName:"tr",align:null},"askRpiPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Best RPI ask price mantissa")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"8"),(0,r.kt)("td",{parentName:"tr",align:null},"askRpiSize"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Best RPI ask size mantissa")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"9"),(0,r.kt)("td",{parentName:"tr",align:null},"bidNormalPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Best bid price mantissa")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"10"),(0,r.kt)("td",{parentName:"tr",align:null},"bidNormalSize"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Best bid size (normal) mantissa")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"11"),(0,r.kt)("td",{parentName:"tr",align:null},"bidRpiPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Best bid price (RPI) mantissa")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"12"),(0,r.kt)("td",{parentName:"tr",align:null},"bidRpiSize"),(0,r.kt)("td",{parentName:"tr",align:null},"int64"),(0,r.kt)("td",{parentName:"tr",align:null},"Best bid size (RPI) mantissa")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"13"),(0,r.kt)("td",{parentName:"tr",align:null},"priceExponent"),(0,r.kt)("td",{parentName:"tr",align:null},"int8"),(0,r.kt)("td",{parentName:"tr",align:null},"Price exponent")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"14"),(0,r.kt)("td",{parentName:"tr",align:null},"sizeExponent"),(0,r.kt)("td",{parentName:"tr",align:null},"int8"),(0,r.kt)("td",{parentName:"tr",align:null},"Size exponent")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"55"),(0,r.kt)("td",{parentName:"tr",align:null},"symbol"),(0,r.kt)("td",{parentName:"tr",align:null},"varStr"),(0,r.kt)("td",{parentName:"tr",align:null},"Trading pair (e.g., ",(0,r.kt)("inlineCode",{parentName:"td"},"BTCUSDT"),")")))),(0,r.kt)("h4",{id:"variable-length-string-varstring8"},"Variable-Length String (",(0,r.kt)("inlineCode",{parentName:"h4"},"varString8"),")"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"uint8 length")," (1 byte) \u2013 number of following characters  "),(0,r.kt)("li",{parentName:"ul"},"UTF-8 string \u2013 trading symbol  ")),(0,r.kt)("p",null,"Example: ",(0,r.kt)("inlineCode",{parentName:"p"},'"BTCUSDT"')," encoded as:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-text"},'0x07 0x42 0x54 0x43 0x55 0x53 0x44 0x54\n^    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^\nlen  "BTCUSDT"\n')),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"optimisation"},"Optimisation"),(0,r.kt)("h3",{id:"optimisation-1"},"Optimisation 1"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"ts")," and ",(0,r.kt)("inlineCode",{parentName:"p"},"cts")," will be displayed in microseconds for BBO SBE."),(0,r.kt)("h3",{id:"optimisation-2"},"Optimisation 2"),(0,r.kt)("p",null,"Adjust the field order."),(0,r.kt)("h3",{id:"optimisation-3"},"Optimisation 3"),(0,r.kt)("p",null,"New field definitions (sell side as example; buy side is analogous):"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Field"),(0,r.kt)("th",{parentName:"tr",align:null},"Definition"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askNormalPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"No RPI order best ask price")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askNormalSize"),(0,r.kt)("td",{parentName:"tr",align:null},"No RPI order best ask size")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askRpiPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"RPI order best ask price")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askRpiSize"),(0,r.kt)("td",{parentName:"tr",align:null},"RPI order best ask size")))),(0,r.kt)("p",null,"The current logic might result in:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Price"),(0,r.kt)("th",{parentName:"tr",align:null},"normalQty"),(0,r.kt)("th",{parentName:"tr",align:null},"rpiQty"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"1000"),(0,r.kt)("td",{parentName:"tr",align:null},"0"),(0,r.kt)("td",{parentName:"tr",align:null},"100")))),(0,r.kt)("p",null,"This means that users without RPI permissions won't know at what price they can take their orders, making this message useless. To address this, we adjust the message content as follows."),(0,r.kt)("h4",{id:"case-1-asknormalsize--0--askrpisize--0"},"Case 1: ",(0,r.kt)("inlineCode",{parentName:"h4"},"askNormalSize != 0 && askRpiSize != 0")),(0,r.kt)("p",null,"This is a normal response based on the actual situation. This case conveys the same meaning as the original message."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Field"),(0,r.kt)("th",{parentName:"tr",align:null},"Definition"),(0,r.kt)("th",{parentName:"tr",align:null},"Example"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askNormalPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"No RPI order best ask price"),(0,r.kt)("td",{parentName:"tr",align:null},"1000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askNormalSize"),(0,r.kt)("td",{parentName:"tr",align:null},"No RPI order best ask size"),(0,r.kt)("td",{parentName:"tr",align:null},"200")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askRpiPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"RPI order best ask price"),(0,r.kt)("td",{parentName:"tr",align:null},"1000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askRpiSize"),(0,r.kt)("td",{parentName:"tr",align:null},"RPI order best ask size"),(0,r.kt)("td",{parentName:"tr",align:null},"300")))),(0,r.kt)("h4",{id:"case-2-asknormalsize--0--askrpisize--0"},"Case 2: ",(0,r.kt)("inlineCode",{parentName:"h4"},"askNormalSize != 0 && askRpiSize == 0")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"askRpiPrice")," is assigned the value ",(0,r.kt)("inlineCode",{parentName:"p"},"askNormalPrice"),", and ",(0,r.kt)("inlineCode",{parentName:"p"},"askRpiSize = 0"),".",(0,r.kt)("br",{parentName:"p"}),"\n","In this case, the ",(0,r.kt)("inlineCode",{parentName:"p"},"askRpiPrice")," value will not be searched further."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Field"),(0,r.kt)("th",{parentName:"tr",align:null},"Definition"),(0,r.kt)("th",{parentName:"tr",align:null},"Example"),(0,r.kt)("th",{parentName:"tr",align:null},"Note"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askNormalPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"No RPI order best ask price"),(0,r.kt)("td",{parentName:"tr",align:null},"1000"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askNormalSize"),(0,r.kt)("td",{parentName:"tr",align:null},"No RPI order best ask size"),(0,r.kt)("td",{parentName:"tr",align:null},"200"),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askRpiPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"RPI order best ask price"),(0,r.kt)("td",{parentName:"tr",align:null},"1000"),(0,r.kt)("td",{parentName:"tr",align:null},"This itself has no meaning. The price field is assigned a non-RPI sell price.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askRpiSize"),(0,r.kt)("td",{parentName:"tr",align:null},"RPI order best ask size"),(0,r.kt)("td",{parentName:"tr",align:null},"0"),(0,r.kt)("td",{parentName:"tr",align:null})))),(0,r.kt)("h4",{id:"case-3-asknormalsize--0--askrpisize--0"},"Case 3: ",(0,r.kt)("inlineCode",{parentName:"h4"},"askNormalSize == 0 && askRpiSize != 0")),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"askNormalPrice =")," the actual non-RPI asking price.",(0,r.kt)("br",{parentName:"p"}),"\n","In this case, ",(0,r.kt)("inlineCode",{parentName:"p"},"askNormalPrice")," is retrieved and returned."),(0,r.kt)("p",null,"Example:"),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Field"),(0,r.kt)("th",{parentName:"tr",align:null},"Definition"),(0,r.kt)("th",{parentName:"tr",align:null},"Example"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askNormalPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"No RPI order best ask price"),(0,r.kt)("td",{parentName:"tr",align:null},"1200")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askNormalSize"),(0,r.kt)("td",{parentName:"tr",align:null},"No RPI order best ask size"),(0,r.kt)("td",{parentName:"tr",align:null},"100")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askRpiPrice"),(0,r.kt)("td",{parentName:"tr",align:null},"RPI order best ask price"),(0,r.kt)("td",{parentName:"tr",align:null},"1000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},"askRpiSize"),(0,r.kt)("td",{parentName:"tr",align:null},"RPI order best ask size"),(0,r.kt)("td",{parentName:"tr",align:null},"20")))),(0,r.kt)("h4",{id:"case-4"},"Case 4"),(0,r.kt)("p",null,"When the market is so bad that there is no liquidity, ",(0,r.kt)("strong",{parentName:"p"},"no message is pushed"),"."),(0,r.kt)("hr",null),(0,r.kt)("h2",{id:"integration-example"},"Integration Example"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-python"},'import json\nimport logging\nimport struct\nimport threading\nimport time\nfrom datetime import datetime\nfrom typing import Dict, Any\n\nimport websocket\n\nlogging.basicConfig(\n    filename="logfile_wrapper.log",\n    level=logging.INFO,\n    format="%(asctime)s %(levelname)s %(message)s",\n)\n\n# Change symbol/topic as you wish\nTOPIC = "ob.rpi.1.sbe.BTCUSDT"\nWS_URL = "wss://stream-testnet.bybits.org/v5/public-sbe/spot"\n\n\nclass SBEBestOBRpiParser:\n    """\n    Parser for BestOBRpiEvent (template_id = 20000) per XML schema:\n\n    ts(int64), seq(int64), cts(int64), u(int64),\n    askNormalPrice(int64), askNormalSize(int64),\n    askRpiPrice(int64), askRpiSize(int64),\n    bidNormalPrice(int64), bidNormalSize(int64),\n    bidRpiPrice(int64), bidRpiSize(int64),\n    priceExponent(int8), sizeExponent(int8),\n    symbol(varString8)\n\n    All values are little-endian.\n    """\n\n    def __init__(self) -> None:\n        # Header: blockLength, templateId, schemaId, version\n        self.header_fmt = "<HHHH"\n        self.header_sz = struct.calcsize(self.header_fmt)\n\n        # 12 x int64 + 2 x int8:\n        # ts, seq, cts, u,\n        # askNormalPrice, askNormalSize, askRpiPrice, askRpiSize,\n        # bidNormalPrice, bidNormalSize, bidRpiPrice, bidRpiSize,\n        # priceExponent, sizeExponent\n        self.body_fmt = "<" + ("q" * 12) + "bb"\n        self.body_sz = struct.calcsize(self.body_fmt)\n\n        self.target_template_id = 20000\n\n    def _parse_header(self, data: bytes) -> Dict[str, Any]:\n        if len(data) < self.header_sz:\n            raise ValueError("insufficient data for SBE header")\n\n        block_length, template_id, schema_id, version = struct.unpack_from(\n            self.header_fmt, data, 0\n        )\n\n        return {\n            "block_length": block_length,\n            "template_id": template_id,\n            "schema_id": schema_id,\n            "version": version,\n        }\n\n    @staticmethod\n    def _parse_varstring8(data: bytes, offset: int) -> tuple[str, int]:\n        if offset + 1 > len(data):\n            raise ValueError("insufficient data for varString8 length")\n\n        (length,) = struct.unpack_from("<B", data, offset)\n        offset += 1\n\n        if offset + length > len(data):\n            raise ValueError("insufficient data for varString8 bytes")\n\n        s = data[offset : offset + length].decode("utf-8")\n        offset += length\n        return s, offset\n\n    @staticmethod\n    def _apply_exponent(value: int, exponent: int) -> float:\n        # Exponent is for decimal point positioning.\n        # If exponent = 2 and value=1060342500 -> 10603425.00\n        return value / (10 ** exponent) if exponent >= 0 else value * (\n            10 ** (-exponent)\n        )\n\n    def parse(self, data: bytes) -> Dict[str, Any]:\n        hdr = self._parse_header(data)\n        if hdr["template_id"] != self.target_template_id:\n            raise NotImplementedError(\n                f"unsupported template_id={hdr[\'template_id\']}"\n            )\n\n        if len(data) < self.header_sz + self.body_sz:\n            raise ValueError("insufficient data for BestOBRpiEvent body")\n\n        fields = struct.unpack_from(self.body_fmt, data, self.header_sz)\n        (\n            ts,\n            seq,\n            cts,\n            u,\n            ask_np_m,\n            ask_ns_m,\n            ask_rp_m,\n            ask_rs_m,\n            bid_np_m,\n            bid_ns_m,\n            bid_rp_m,\n            bid_rs_m,\n            price_exp,\n            size_exp,\n        ) = fields\n\n        offset = self.header_sz + self.body_sz\n        symbol, offset = self._parse_varstring8(data, offset)\n\n        # Apply exponents\n        ask_np = self._apply_exponent(ask_np_m, price_exp)\n        ask_ns = self._apply_exponent(ask_ns_m, size_exp)\n        ask_rp = self._apply_exponent(ask_rp_m, price_exp)\n        ask_rs = self._apply_exponent(ask_rs_m, size_exp)\n        bid_np = self._apply_exponent(bid_np_m, price_exp)\n        bid_ns = self._apply_exponent(bid_ns_m, size_exp)\n        bid_rp = self._apply_exponent(bid_rp_m, price_exp)\n        bid_rs = self._apply_exponent(bid_rs_m, size_exp)\n\n        return {\n            "header": hdr,\n            "ts": ts,\n            "seq": seq,\n            "cts": cts,\n            "u": u,\n            "price_exponent": price_exp,\n            "size_exponent": size_exp,\n            "symbol": symbol,\n            # Normal book (best)\n            "ask_normal_price": ask_np,\n            "ask_normal_size": ask_ns,\n            "bid_normal_price": bid_np,\n            "bid_normal_size": bid_ns,\n            # RPI book (best)\n            "ask_rpi_price": ask_rp,\n            "ask_rpi_size": ask_rs,\n            "bid_rpi_price": bid_rp,\n            "bid_rpi_size": bid_rs,\n            "parsed_length": offset,\n        }\n\n\nparser = SBEBestOBRpiParser()\n\n\n# --------------------------- WebSocket handlers ---------------------------\n\ndef on_message(ws, message):\n    try:\n        # Binary SBE frames; text frames for control/acks/errors\n        if isinstance(message, (bytes, bytearray)):\n            decoded = parser.parse(message)\n            logging.info(\n                "SBE %s seq=%s u=%s "\n                "NORM bid=%.8f@%.8f ask=%.8f@%.8f "\n                "RPI bid=%.8f@%.8f ask=%.8f@%.8f ts=%s",\n                decoded["symbol"],\n                decoded["seq"],\n                decoded["u"],\n                decoded["bid_normal_price"],\n                decoded["bid_normal_size"],\n                decoded["ask_normal_price"],\n                decoded["ask_normal_size"],\n                decoded["bid_rpi_price"],\n                decoded["bid_rpi_size"],\n                decoded["ask_rpi_price"],\n                decoded["ask_rpi_size"],\n                decoded["ts"],\n            )\n            print(\n                f"{decoded[\'symbol\']} u={decoded[\'u\']} "\n                f"NORM: {decoded[\'bid_normal_price\']:.8f} x {decoded[\'bid_normal_size\']:.8f} "\n                f"| {decoded[\'ask_normal_price\']:.8f} x {decoded[\'ask_normal_size\']:.8f} "\n                f"RPI: {decoded[\'bid_rpi_price\']:.8f} x {decoded[\'bid_rpi_size\']:.8f} "\n                f"| {decoded[\'ask_rpi_price\']:.8f} x {decoded[\'ask_rpi_size\']:.8f} "\n                f"(seq={decoded[\'seq\']} ts={decoded[\'ts\']})"\n            )\n        else:\n            try:\n                obj = json.loads(message)\n                logging.info("TEXT %s", obj)\n                print(obj)\n            except json.JSONDecodeError:\n                logging.warning("non-JSON text frame: %r", message)\n    except Exception as e:\n        logging.exception("decode error: %s", e)\n        print("decode error:", e)\n\n\ndef on_error(ws, error):\n    print("WS error:", error)\n    logging.error("WS error: %s", error)\n\n\ndef on_close(ws, *_):\n    print("### connection closed ###")\n    logging.info("connection closed")\n\n\ndef on_open(ws):\n    print("opened")\n    sub = {"op": "subscribe", "args": [TOPIC]}\n    ws.send(json.dumps(sub))\n    print("subscribed:", TOPIC)\n\n    threading.Thread(target=ping_per, args=(ws,), daemon=True).start()\n    threading.Thread(target=manage_subscription, args=(ws,), daemon=True).start()\n\n\ndef manage_subscription(ws):\n    # demo: unsubscribe/resubscribe once\n    time.sleep(20)\n    ws.send(json.dumps({"op": "unsubscribe", "args": [TOPIC]}))\n    print("unsubscribed:", TOPIC)\n    time.sleep(5)\n    ws.send(json.dumps({"op": "subscribe", "args": [TOPIC]}))\n    print("resubscribed:", TOPIC)\n\n\ndef ping_per(ws):\n    while True:\n        try:\n            ws.send(json.dumps({"op": "ping"}))\n        except Exception:\n            return\n        time.sleep(10)\n\n\ndef on_pong(ws, *_):\n    print("pong received")\n\n\ndef on_ping(ws, *_):\n    print("ping received @", datetime.now().strftime("%Y-%m-%d %H:%M:%S"))\n\n\ndef connWS():\n    ws = websocket.WebSocketApp(\n        WS_URL,\n        on_open=on_open,\n        on_message=on_message,\n        on_error=on_error,\n        on_close=on_close,\n        on_ping=on_ping,\n        on_pong=on_pong,\n    )\n    ws.run_forever(ping_interval=20, ping_timeout=10)\n\n\nif __name__ == "__main__":\n    websocket.enableTrace(False)\n    connWS()\n')))}m.isMDXComponent=!0}}]);